var detalleLineasContenedoreses=[];function validarBusquedaContenedor(){var e=document.getElementById("bodega").value,t=document.getElementById("bodegaSelectOC").value;""===document.getElementById("placa-camion").value||""==t?Swal.fire({icon:"warning",title:"Advertencia",text:"Faltan par√°metros para cargar los datos.\nVerifique que se hayan llenado correctamente los campos de la bodega de destino y la placa del cami√≥n."}):(mostrarLoader(),e="?pSistema=WMS&pUsuario="+document.getElementById("hUsuario").value+"&pOpcion=B&pBodegaEnvia="+e+"&pBodegaDestino="+t+"&pContenedor="+$("#pContenedor").val()+"&pEstado=&pFechaDesde="+$("#fecha_ini").val()+"&pArticulo=",localStorage.setItem("parametrosBusquedaPaquete",e),enviarDatosControlador(e))}function enviarDatosControlador(e){console.log("BUSQUEDA CONTENEDOR PARAMETROS\n "+e),fetch(env.API_URL+"verificadordecontenedores"+e,myInit).then(e=>e.json()).then(e=>{"SUCCESS"===e.msg?(ocultarLoader(),detalleLineasContenedoreses=e.respuesta,0!=e.respuesta.length?(armarTablaLectura(detalleLineasContenedoreses),guardarTablaEnArray(),armarTablaVerificacion(detalleLineasContenedoreses),mostrarPestanaLectura(),console.log("REsultados:"),console.log(detalleLineasContenedoreses),Swal.fire({icon:"info",title:"Informaci√≥n",text:"Registros cargados en la pesta√±a Verificaci√≥n",confirmButtonColor:"#28a745"})):(ocultarLoader(),Swal.fire({icon:"info",title:"Informaci√≥n",text:"No hay registros asignados para el usuario",confirmButtonColor:"#28a745"})),document.getElementById("carga").innerHTML=""):Swal.fire({icon:"error",title:"error",text:"Se registro un error en la aplicaci√≥n",confirmButtonColor:"#28a745"})}),ocultarLoader()}function mostrarPestanaLectura(){document.querySelector('#tabs-swipe-demo a[href="#tabla-lectura"]').click(),document.getElementById("codigo-barras").focus()}function limpiarResultadoGeneral(){var e=document.getElementById("tblcontenedores"),t=document.getElementById("resultadoPaginador"),a=document.getElementById("totalregistros");t&&(t.innerHTML=""),a&&(a.innerHTML=""),e&&(t=e.querySelector("tbody"))&&(t.innerHTML="")}function limpiarTblLectura(){var e=document.getElementById("myTableLectura");e&&(e=e.querySelector("tbody"))&&(e.innerHTML="")}function cargarBodegas(){fetch(env.API_URL+"wmsmostarbodegasconsultaordencompra").then(e=>e.json()).then(e=>{let a=document.getElementById("bodegaSelectOC");e.respuesta&&Array.isArray(e.respuesta)?(a.innerHTML='<option value="" disabled selected>Seleccione una bodega</option>',e.respuesta.forEach(e=>{var t=document.createElement("option");t.value=e.BODEGA,t.textContent=e.NOMBRE,a.appendChild(t)}),M.FormSelect.init(a)):console.error("No se encontraron bodegas.")}).catch(e=>console.error("Error al cargar las bodegas:",e))}function armarTablaLectura(e){var a=document.getElementById("tblbodyLectura");a.classList.add("display","centered"),a.innerHTML="",e.forEach(function(e){var t;null!=e.Cant_Leida&&""!==e.Cant_Leida&&0!=e.Cant_Leida&&((t=document.createElement("tr")).innerHTML=`
                <td>
                    <span style="display: block; text-align: center;">${e.Articulo}</span>
                </td>
                <td class="codigo-barras-cell" style="text-align: center;">
                    <input id="codigo-barras" type="text" class="codigo-barras-input" value="${e.Codigo_Barra||""}" onchange="validarCodigoBarras(this)" autofocus>
                </td>
                <td class="codigo-barras-cell2" style="text-align: center;">
                    <input id="cant-pedida" style="text-align: center;" type="text" class="codigo-barras-input" value="${e.Cant_Leida||""}" onchange="guardarTablaEnArray(this)">
                </td>
                <td class="codigo-barras-cell2" style="text-align: center;">
                <i class="material-icons red-text" style="cursor: pointer;" onclick="eliminarFila(this)">clear</i>
                </td>
            `,a.appendChild(t))}),guardarTablaEnArray(),crearNuevaFila()}function validarCodigoBarras(t){for(var a=detalleLineasContenedoreses,o=t.value.toUpperCase(),r=t.closest("tr"),n=r.querySelector("td:first-child").querySelector("span"),l=r.querySelector(".codigo-barras-cell2").querySelector(".codigo-barras-input"),i=!1,c=0;c<a.length;c++){let e=[];if(a[c].codigos_barras&&(e=a[c].codigos_barras.split("|").map(e=>e.toUpperCase())),a[c].Articulo&&a[c].Articulo.toUpperCase()===o||a[c].Codigo_Barra&&a[c].Codigo_Barra.toUpperCase()===o||e.includes(o)){if(0<a[c].total_cedi){n.textContent=a[c].Articulo,l.value=1,t.setAttribute("readonly","readonly"),crearNuevaFila(),guardarTablaEnArray(),i=!0;break}Swal.fire({icon:"warning",title:"¬°Articulo sin Existencias!",text:"La referencia "+a[c].Articulo+" no cuenta con existencias",confirmButtonColor:"#28a745"});i=!0;r.querySelector(".codigo-barras-cell").querySelector(".codigo-barras-input").value="";break}}i||(r.querySelector(".codigo-barras-cell").querySelector(".codigo-barras-input").value="",Swal.fire({icon:"warning",title:"¬°C√≥digo no v√°lido!",text:"El c√≥digo ingresado no coincide con ning√∫n art√≠culo de la solicitud. Intente nuevamente.",confirmButtonColor:"#28a745"}))}function crearNuevaFila(){var e=document.querySelector("#tblbodyLectura"),e=(e.classList.add("display","centered"),e.insertAdjacentHTML("beforeend",`<tr>
            <td class="sticky-column" style="text-align: center;" style="user-select: none;"><span display: inline-block;"></span></td>
            <td class="codigo-barras-cell" style="text-align: center;"><input type="text" style="text-align: center;" id="codigo-barras" class="codigo-barras-input" value="" onchange="validarCodigoBarras(this)" autofocus></td>
            <td class="codigo-barras-cell2" style="text-align: center;"><input id="cant-pedida" style="text-align: center;" type="text" class="codigo-barras-input" value="" onchange="actualizaLectura(this)"></td>
            <td class="codigo-barras-cell2" style="text-align: center;"><i class="material-icons red-text" style="cursor: pointer;" onclick="eliminarFila(this)">clear</i></td>
        </tr>`),e.querySelector("tr:last-child .codigo-barras-input"));e&&e.focus()}function actualizaLectura(){guardarTablaEnArray()}function guardarTablaEnArray(){for(var e=[],t=document.getElementById("myTableLectura").getElementsByTagName("tr"),a=1;a<t.length;a++){var o=t[a].getElementsByTagName("td"),r=o[0].querySelector("span").textContent.trim(),n=o[1].querySelector(".codigo-barras-input"),o=o[2].querySelector(".codigo-barras-input"),n=n.value,o=parseFloat(o.value);null===r||""===r||isNaN(o)||e.push({ARTICULO:r,CODIGO_BARRA:n,CANTIDAD_LEIDA:o})}return localStorage.setItem("dataArray",JSON.stringify(e)),agrupar(),e}function agrupar(){var e,t=JSON.parse(localStorage.getItem("dataArray"))||[],a={},o=(t.forEach(function(e){var t=e.ARTICULO,e=e.CANTIDAD_LEIDA;a.hasOwnProperty(t)?a[t]+=e:a[t]=e}),[]);for(e in a)a.hasOwnProperty(e)&&o.push({ARTICULO:e,CANTIDAD_LEIDA:a[e]});localStorage.setItem("dataArray",JSON.stringify(o))}function eliminarFila(e){var a=e.closest("tr");Swal.fire({title:"¬øEst√°s seguro?",text:"A continuaci√≥n se va a eliminar una fila de la pesta√±a lectura",icon:"warning",showCancelButton:!0,confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881",confirmButtonText:"S√≠, eliminar"}).then(e=>{var t;e.isConfirmed&&(t=!0,e=a.querySelectorAll(".codigo-barras-input"),a.querySelector,e.forEach(function(e){""!==e.value.trim()&&(t=!1)}),t?(guardarTablaEnArray(),Swal.fire({icon:"warning",title:"Est√° intentando borrar una fila vacia",confirmButtonText:"Cerrar"})):(a.remove(),(e=document.querySelector("#tblbodyLectura").querySelector("tr:last-child .codigo-barras-input"))&&e.focus(),guardarTablaEnArray()))})}function limpiarMensajes(){localStorage.removeItem("mensajes"),document.getElementById("mensajeText").value="",guardarTablaEnArray()}function armarTablaVerificacion(e){let a=document.getElementById("tblbodyLineasContenedor");a.innerHTML="",document.getElementById("cantidadDeRegistros").textContent="Cantidad de registros: "+e.length,e.forEach(e=>{var t=document.createElement("tr");t.innerHTML=`
      <td class="solicitud" hidden>${e.Traslado}</td>        
      <td class="contenedor" style="text-align: left;">
          <h5>${e.Contenedor}</h5>
          <h6>${e.Traslado}</h6>
      </td>
      <td class="articulo">
          <h5 class="verifica-articulo">
              <span class="blue-text text-darken-2">${e.Articulo}</span>
          </h5>
          <h6 style="text-align:left;">${e.Descripcion}</h6>
      </td>           
      <td class="cantidadPedida" style="text-align: left;">
          ${isNaN(parseFloat(e.Cant_Pedida))?0:parseFloat(e.Cant_Pedida).toFixed(2)}
      </td>        
      <td class="cantidadPreparada" style="text-align: left;">
          ${isNaN(parseFloat(e.Cant_Verificada))?0:parseFloat(e.Cant_Verificada).toFixed(2)}
      </td>
      <td class="cantidadLeida" style="text-align: left;"></td>
      <td class="verificado" style="text-align: left;"></td>      
      <td class="devolver" style="text-align: left;">
         <i class="material-icons" 
           style="color: #FF0000; cursor: pointer;" 
           onclick="autorizaDevolucion('${e.Articulo}', '${e.Contenedor}','${isNaN(parseFloat(e.Cant_Verificada))?0:parseFloat(e.Cant_Verificada).toFixed(2)}')">reply</i>
      </td>        
    `,a.appendChild(t)})}function verificacion(){var e=JSON.parse(localStorage.getItem("dataArray"))||[],t=(console.log("DataArray",e),document.getElementById("tblcontenedores"));if(!t)return console.warn("‚ö†Ô∏è No se encontr√≥ la tabla de verificaci√≥n.");t=t.querySelectorAll("tbody tr");let n=[],l=(t.forEach(e=>{var t=e.querySelector(".cantidadLeida"),e=e.querySelector(".verificado");t&&(t.textContent=""),e&&(e.textContent="")}),{});e.forEach(e=>{var t=e.ARTICULO.trim(),e=parseFloat(e.CANTIDAD_LEIDA)||0;l[t]=(l[t]||0)+e}),t.forEach(e=>{var t,a=e.querySelector(".verifica-articulo span"),o=e.querySelector(".cantidadPreparada"),r=e.querySelector(".cantidadLeida"),e=e.querySelector(".verificado");a&&o&&(a=a.textContent.trim(),o=parseFloat(o.textContent)||0,t=l.hasOwnProperty(a)?l[a]:null,r&&(r.textContent=t),t===o&&0<t?e&&((r=document.createElement("span")).classList.add("material-icons"),r.textContent="done_all",r.style.color="green",e.appendChild(r)):o<t?(r=(t-o).toFixed(2),e&&(e.textContent="+"+r),n.push(`*La cantidad verificada del art√≠culo ${a} es mayor a la solicitada.`)):t<o&&0<t&&(r=(t-o).toFixed(2),e&&(e.textContent=r),n.push(`>La cantidad verificada del art√≠culo ${a} es menor a la solicitada.`)))}),localStorage.setItem("mensajes",JSON.stringify(n)),limpiarMensajes();e=document.getElementById("mensajeText");e&&(e.value=n.join("\n"))}function inicializarBotones(){var e=document.createElement("div"),t=document.createElement("div"),a=document.createElement("button"),o=document.createElement("button"),r=(a.textContent="Crear Paquete",a.id="btnCrearPaqueteContenedor",a.hidden=!1,a.onclick=guardaPaquete,o.textContent="Guardar",o.id="btnGuardar",o.hidden=!1,o.onclick=confirmarGuardadoParcial,o.style.backgroundColor="#28a745",o.style.borderRadius="5px",o.style.color="white",o.style.marginTop="16px",o.style.marginLeft="16px",o.style.marginRight="16px",o.style.height="36px",o.style.width="100px",a.style.width="100px",a.style.backgroundColor="#28a745",a.style.borderRadius="5px",a.style.color="white",a.style.marginTop="16px",a.style.marginLeft="6em",a.style.height="40px",a.style.marginbottom="25px",e.appendChild(o),t.appendChild(o),t.appendChild(a),document.getElementById("myTableLectura")),n=document.getElementById("tblcontenedores"),e=(r.parentNode.insertBefore(e,r.nextSibling),n.parentNode.insertBefore(t,n.nextSibling),window.matchMedia("(min-width: 64em)"));e.matches&&(o.style.marginLeft="200px",a.style.marginLeft="500px")}function mostrarMensajesLocalStorage(){var e=localStorage.getItem("mensajes");if(e){var t=JSON.parse(e),a=document.getElementById("mensajeText");a.value="";for(let e=0;e<t.length;e++)a.value+=t[e]+"\n"}}function confirmarGuardadoParcial(){Swal.fire({icon:"info",title:"¬øA continuaci√≥n se guardaran los datos leidos de la pesta√±a verificaci√≥n...?",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881"}).then(e=>{e.isConfirmed&&guardaParcialMente()})}async function guardaParcialMente(){var e=document.getElementById("hUsuario").value,a=document.getElementById("bodega").value,o=document.getElementById("bodegaSelectOC").value,r=(new Date).toISOString().split("T")[0],n=document.getElementById("placa-camion").value,t=document.getElementById("tblcontenedores"),l=[];for(let e=1;e<t.rows.length;e++){var i=t.rows[e],c=i.querySelector(".contenedor h5")?.textContent.trim()||"0",s=i.querySelector(".solicitud")?.textContent.trim()||"0",d=i.querySelector(".verifica-articulo span")?.textContent.trim()||"",u=Number(i.querySelector(".cantidadPedida")?.textContent.trim()||0),p=Number(i.querySelector(".cantidadPreparada")?.textContent.trim()||0),i=Number(i.querySelector(".cantidadLeida")?.textContent.trim()||0);l.push({CONTENEDOR:c,SOLICITUD:s,ARTICULO:d,CANT_CONSEC:u,CANT_PREPARADA:p,CANT_LEIDA:i})}console.log("detallesARRAY:\n ",l);var m=[];for(let e=0;e<l.length;e+=20)m.push(l.slice(e,e+20));var g={method:"GET",headers:{"Content-Type":"application/json"}};for(let t=0;t<m.length;t++){var C=encodeURIComponent(JSON.stringify(m[t])),f="?pSistema=WMS&pUsuario="+e+"&pOpcion=L&pBodegaOrigen="+a+"&pBodegaDestino="+o+"&pFecha="+r+"&pPlaca="+n+"&jsonPaquete="+C+"&pReferencia=Ref o null&pComentario=Comentario o null";console.log("PARAMETROS: "+f),console.log(`üì¶ Enviando lote ${t+1} de ${m.length}...`),console.log("jsonPaquete=\n",C),console.log("Fin...");try{var y=await(await fetch(env.API_URL+"guardacreapaquete"+f,g)).json();if(console.log(`‚úÖ Lote ${t+1} procesado`,y),"SUCCESS"!==y.msg){console.warn("‚ö†Ô∏è Error en lote "+(t+1),y);break}}catch(e){console.error(`üö® Error al enviar lote ${t+1}:`,e);break}}Swal.fire({icon:"success",title:"Todos los datos fueron Guardados correctamente",confirmButtonText:"Aceptar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881"}).then(e=>{e.isConfirmed&&mostrarPestanaLectura()})}async function guardaPaquete(){var e=document.getElementById("hUsuario").value,a=document.getElementById("bodega").value,o=document.getElementById("bodegaSelectOC").value,r=(new Date).toISOString().split("T")[0],n=document.getElementById("placa-camion").value,t=document.getElementById("tblcontenedores"),l=[];for(let e=1;e<t.rows.length;e++){var i=t.rows[e],c=i.querySelector(".contenedor h5")?.textContent.trim()||"0",s=i.querySelector(".solicitud")?.textContent.trim()||"0",d=i.querySelector(".verifica-articulo span")?.textContent.trim()||"",u=Number(i.querySelector(".cantidadPedida")?.textContent.trim()||0),p=Number(i.querySelector(".cantidadPreparada")?.textContent.trim()||0),i=Number(i.querySelector(".cantidadLeida")?.textContent.trim()||0);l.push({CONTENEDOR:c,SOLICITUD:s,ARTICULO:d,CANT_CONSEC:u,CANT_PREPARADA:p,CANT_LEIDA:i})}console.log("detallesARRAY:\n ",l),console.log("Total de registros a enviar: "+l.length);var m=[];for(let e=0;e<l.length;e+=20)m.push(l.slice(e,e+20));console.log(`Se dividir√°n en ${m.length} lotes de 20 (√∫ltimo puede ser menor)`);var g={method:"GET",headers:{"Content-Type":"application/json"}};for(let t=0;t<m.length;t++){var C=encodeURIComponent(JSON.stringify(m[t])),f="?pSistema=WMS&pUsuario="+e+"&pOpcion=L&pBodegaOrigen="+a+"&pBodegaDestino="+o+"&pFecha="+r+"&pPlaca="+n+"&jsonPaquete="+C+"&pReferencia=Ref o null&pComentario=Comentario o null";console.log("PARAMETROS: "+f),console.log(`üì¶ Enviando lote ${t+1} de ${m.length}...`),console.log("jsonPaquete=\n",C),console.log("Fin...");try{var y=await(await fetch(env.API_URL+"guardacreapaquete"+f,g)).json();if(console.log(`‚úÖ Lote ${t+1} procesado`,y),"SUCCESS"!==y.msg){console.warn("‚ö†Ô∏è Error en lote "+(t+1),y);break}}catch(e){console.error(`üö® Error al enviar lote ${t+1}:`,e);break}}console.log("Se guardaron los elementos de la tabla lectura y se va a crear el paquete."),ConfirmaCrearPaqueteContenedores()}function ConfirmaCrearPaqueteContenedores(){Swal.fire({icon:"warning",title:"¬øDesea procesar el contenedor?",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881"}).then(e=>{e.isConfirmed&&(validarVerificacion()?CrearPaqueteContenedores():Swal.fire({title:"Ingrese sus credenciales",html:'<input id="swal-input1" class="swal2-input" placeholder="Usuario" autocomplete="off"><input id="swal-input2" class="swal2-input" placeholder="Contrase√±a" type="password" autocomplete="off">',focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Aprobar",cancelButtonText:"Cancelar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881",preConfirm:()=>({usuario:document.getElementById("swal-input1").value.toUpperCase(),"contrase√±a":document.getElementById("swal-input2").value})}).then(e=>{!e.isDismissed&&e.value&&e.value.usuario&&e.value.contrase√±a?(e="?pSistema=WMS&pUsuario="+e.value.usuario+"&pOpcion="+e.value.contrase√±a,fetch(env.API_URL+"wmsautorizaciones"+e).then(e=>e.json()).then(e=>{console.log("Autorizacion Resultado: "),console.log(e.autorizacion[0].mensaje),"OK"===e.autorizacion[0].mensaje?(console.log("Credenciales v√°lidas"),CrearPaqueteContenedores()):(console.log("Credenciales inv√°lidas"),Swal.fire({icon:"error",title:"Error",text:"Credenciales inv√°lidas"}))}).catch(e=>{console.error("Error al obtener los datos del API:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo obtener los datos del API"})})):(console.error("Error: No se pudieron obtener los valores de usuario y contrase√±a del Swal"),Swal.fire({icon:"error",title:"Error",text:"No se pudieron obtener los valores de usuario y contrase√±a del Swal"}))}))})}function CrearPaqueteContenedores(){var e=document.getElementById("hUsuario").value,t=document.getElementById("bodega").value,a=document.getElementById("bodegaSelectOC").value,o=(new Date).toISOString().split("T")[0],r=document.getElementById("placa-camion").value;fetch(env.API_URL+"guardacreapaquete"+("?pSistema=WMS&pUsuario="+e+"&pOpcion=R&pBodegaOrigen="+t+"&pBodegaDestino="+a+"&pFecha="+o+"&pPlaca="+r+"&jsonPaquete=&pReferencia=Ref o null&pComentario=Comentario o null"),myInit).then(e=>e.json()).then(e=>{if(console.log("Respuesta del SP"),console.log(e.respuesta),"SUCCESS"===e.msg)if(0!=e.respuesta.length){let t=e.respuesta[0].Respuesta;console.log("Respuesta del API:\n"+e.respuesta[0].Respuesta),e.respuesta[0].Respuesta.toUpperCase().startsWith("TRAS")?Swal.fire({icon:"success",title:"Se cre√≥ el paquete N¬∞ "+t+" con √©xito",showDenyButton:!0,confirmButtonText:"Aceptar",denyButtonText:"Imprimir",confirmButtonColor:"#28a745",denyButtonColor:"#007bff",cancelButtonColor:"#6e7881"}).then(e=>{e.isConfirmed||e.isDenied&&(imprimirPaqueteReporte(t),limpiarResultadoGeneral(),limpiarMensajes(),location.reload())}):Swal.fire({icon:"error",title:e.respuesta[0].Respuesta,confirmButtonText:"Aceptar",confirmButtonColor:"#28a745"})}else console.log("El API no devolvio nada")})}document.addEventListener("DOMContentLoaded",function(){document.getElementById("hUsuario").value;cargarBodegas()}),document.querySelector('a[href="#tabla-verificacion"]').addEventListener("click",mostrarMensajesLocalStorage);let validarVerificacion=()=>{var e=document.querySelectorAll("#tblbodyLineasContenedor tr");return 0!==e.length&&Array.from(e).every(e=>{e=e.cells[6];return!!e&&"done_all"===e.querySelector(".material-icons")?.textContent?.trim()})};function columnaEstaVacia(){for(var e=document.querySelectorAll("#tblbodyLineasContenedor td#cantidadLeida"),t=0;t<e.length;t++)if(""!==e[t].textContent.trim())return!1;return!0}function permisoCrearPaquete(){let e=sessionStorage.getItem("user")?.trim()||"";"JOSENAVA"===(e=e.replace(/^["'](.*)["']$/,"$1"))?Swal.fire({icon:"info",title:"Permisos",text:"permiso consedido",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881"}):Swal.fire({icon:"info",title:"√ëagare",text:"permiso  no consedido",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881"})}async function imprimirPaqueteReporte(e){var t=document.getElementById("hUsuario").value;let o=e;e="?pSistema=WMS&pUsuario="+t+"&pTipoConsulta=l&pPaquete="+o;fetch(env.API_URL+"imprimepaquete"+e,myInit).then(e=>e.json()).then(e=>{var t,a;"SUCCESS"===e.msg&&0<e.respuesta.length&&(t=window.jspdf.jsPDF,(t=new t("P","pt","a4")).setFontSize(16),t.setFont("helvetica","bold"),t.text("CREACI√ìN DE PAQUETES",t.internal.pageSize.getWidth()/2,40,{align:"center"}),t.setFontSize(14),t.setFont("helvetica","normal"),t.text("PAQUETE: "+o,t.internal.pageSize.getWidth()/2,60,{align:"center"}),t.setFontSize(12),t.text("Cami√≥n: "+(e.respuesta[0].REFERENCIA||"N/A"),40,90),a=["ART√çCULO","C√ìDIGO\nBARRAS","CANT\nSOLI","CANT\nPREP.","CANT\nVERIF.","CONSECUTIVO\nCONTENEDOR","FECHA\nCREACI√ìN"],e=e.respuesta.map(e=>[e.articulo+`
`+e.descripcion,e.Codigo_Barra,e.LineaConsecutivo,e.LineaAprobada,e.LineaVerificada,e.Contenedor,e.Fecha_Aplicacion]),t.autoTable({head:[a],body:e,startY:140,styles:{fontSize:8,cellWidth:"wrap"},headStyles:{fillColor:[40,167,69]},tableWidth:"auto",columnStyles:{0:{cellWidth:120}}}),t.save("Reporte_Paquete_"+o+".pdf"))})}function autorizaDevolucion(a,o,r){Swal.fire({title:"Ingrese sus credenciales",html:'<input id="swal-input1" class="swal2-input" placeholder="Usuario" autocomplete="off"><input id="swal-input2" class="swal2-input" placeholder="Contrase√±a" type="password" autocomplete="off">',focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Aprobar",cancelButtonText:"Cancelar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881",preConfirm:()=>({usuario:document.getElementById("swal-input1").value.toUpperCase(),"contrase√±a":document.getElementById("swal-input2").value})}).then(t=>{!t.isDismissed&&t.value&&t.value.usuario&&t.value.contrase√±a?fetch(env.API_URL+"wmsautorizacioncontenedor").then(e=>e.json()).then(e=>{e=e.respuesta[0];e&&e.USUARIO===t.value.usuario&&e.PIN===t.value.contrase√±a?(localStorage.setItem("UsuarioAutorizacion",e.USUARIO),devolverArticulo(a,o,r)):Swal.fire({icon:"error",title:"Error",text:"Credenciales inv√°lidas"})}).catch(e=>{Swal.fire({icon:"error",title:"Error",text:e})}):Swal.fire({icon:"error",title:"Error",text:"No se pudieron obtener los valores de usuario y contrase√±a del Swal"})})}function devolverArticulo(t,e,a){var o,r=(JSON.parse(localStorage.getItem("dataArray"))||[]).find(e=>e.ARTICULO.trim().toUpperCase()===t.trim().toUpperCase());r?(r=parseFloat(r.CANTIDAD_LEIDA)||0,o=(a=parseFloat(a)||0)-r,Swal.fire({title:"Devolver Art√≠culo",html:`
      <p>¬øEst√°s seguro de devolver el art√≠culo <b>${t}</b>?</p>
      <p>Contenedor: <b>${e}</b></p>
      <p>Cantidad preparada: <b>${a.toFixed(2)}</b></p>
      <p>Cantidad le√≠da: <b>${r.toFixed(2)}</b></p>
      <hr>
      <p><b>Diferencia a devolver:</b> ${o.toFixed(2)}</p>
    `,icon:"question",showCancelButton:!0,confirmButtonText:"S√≠, devolver",cancelButtonText:"Cancelar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881"}).then(e=>{e.isConfirmed&&(e="?pSistema=WMS&pUsuario="+document.getElementById("hUsuario").value+"&pOpcion=c&pBodegaEnvia="+document.getElementById("bodega").value+"&pBodegaDestino="+document.getElementById("bodegaSelectOC").value+"&pContenedor="+$("#pContenedor").val()+"&pEstado=&pFechaDesde="+$("#fecha_ini").val()+"&pArticulo="+t,localStorage.setItem("parametrosBusquedaContenedor",e),fetch(env.API_URL+"verificadordecontenedores"+e,myInit).then(e=>e.json()).then(e=>{"SUCCESS"===e.msg?(detalleLineasContenedoreses=e.respuesta,0!=e.respuesta.length?mostrarTablaEnSwal(detalleLineasContenedoreses):Swal.fire({icon:"info",title:"Informaci√≥n",text:"Ocurrio un error al cargar las lineas para devoluci√≥n",confirmButtonColor:"#28a745"}),document.getElementById("carga").innerHTML=""):Swal.fire({icon:"error",title:"error",text:"Se registro un error en la llamada al API",confirmButtonColor:"#28a745"})}))})):Swal.fire({title:"Art√≠culo no encontrado",text:`El art√≠culo ${t} no tiene registros de lectura.`,icon:"warning",confirmButtonText:"Aceptar",confirmButtonColor:"#6e7881"})}async function mostrarTablaEnSwal(o){var e=document.getElementById("hUsuario").value,t=document.getElementById("bodega").value,a=localStorage.getItem("bodega_solicita"),r=localStorage.getItem("UsuarioAutorizacion")||"";let n=o[0]?.Articulo||"Sin Art√≠culo";var l=o.map((e,t)=>`
      <tr>
        <td><h5>${e.Contenedor||""}</h5><h6>${e.Traslado||""}</h6></td>
        <td>${Number(e.Cant_Verificada||0).toFixed(2)}</td>
        <td><input type="number" min="0" class="devolver-input" data-index="${t}" placeholder="0" style="width: 80px;"></td>
      </tr>
    `).join(""),l=(await Swal.fire({title:"L√≠neas para devoluci√≥n - Art√≠culo: "+n,html:`
    <table class="highlight centered" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Contenedor</th>
          <th>Cant. Preparada</th>
          <th>Cant. a Devolver</th>
        </tr>
      </thead>
      <tbody>${l}</tbody>
    </table>
  `,icon:"info",confirmButtonText:"Aceptar",confirmButtonColor:"#28a745",showCancelButton:!0,cancelButtonText:"Cancelar",preConfirm:()=>{var e=document.querySelectorAll(".devolver-input");return Array.from(e).map(e=>{var t=parseInt(e.getAttribute("data-index")),e=parseFloat(e.value)||0,a=Number(o[t].Cant_Verificada||0);if(a<e)throw new Error(MESSAGES.ERROR_EXCEEDS(o[t].Contenedor));return{index:t,CONTENEDOR:o[t].Contenedor,SOLICITUD:o[t].Traslado,ARTICULO:n,CANT_PREPARADA:a,CANT_LEIDA:e}}).filter(e=>0<e.CANT_LEIDA)}})).value;if(l){e="?pSistema=WMS&pUsuario="+e+"&pOpcion=D&BodegaSolic="+a+"&BodegaEnvia="+t+"&pUsuarioAutorizacion="+r+"&jsonDetalles="+JSON.stringify(l.map(({CONTENEDOR:e,SOLICITUD:t,ARTICULO:a,CANT_PREPARADA:o,CANT_LEIDA:r})=>({CONTENEDOR:e,SOLICITUD:t,ARTICULO:a,CANT_PREPARADA:o,CANT_LEIDA:r})));try{await enviarCantidadesDevolucion(e)}catch(e){Swal.fire({icon:"error",title:"Error",text:MESSAGES.ERROR_API,confirmButtonColor:"#28a745"})}}}async function enviarCantidadesDevolucion(e){fetch(env.API_URL+"devolverarticulocontenedor"+e,myInit).then(e=>e.json()).then(e=>{console.log("Respuesta del SP"),console.log(e.respuesta),console.log("Respuesta Contenedor"),console.log(e),"SUCCESS"===e.msg&&0!=e.respuesta.length&&Swal.fire({icon:"success",title:"Articulo devuelto correctamente",confirmButtonText:"Aceptar",confirmButtonColor:"#28a745",cancelButtonColor:"#6e7881"}).then(e=>{e.isConfirmed&&actualizaTablaVerificacion()})})}function actualizaTablaVerificacion(){var e,t=localStorage.getItem("parametrosBusquedaPaquete");t&&(e="?pSistema="+((e=new URLSearchParams(t)).get("pSistema")??"")+"&pUsuario="+(e.get("pUsuario")??"")+"&pOpcion="+(e.get("pOpcion")??"")+"&pBodegaEnvia="+(e.get("pBodegaEnvia")??"")+"&pBodegaDestino="+e.get("pBodegaDestino")+"&pContenedor="+(e.get("pContenedor")??"")+"&pEstado=&pFechaDesde="+(e.get("pFechaDesde")??"")+"&pArticulo=",console.log(""+t),console.log("PARAMSET"+e),enviarDatosControlador(e))}window.onload=function(){inicializarBotones(),guardarTablaEnArray()};